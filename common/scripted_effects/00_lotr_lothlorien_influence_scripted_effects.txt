

# Initialize the variables at game start
lthi_initialize_values = {
	set_variable = { lthi_base_nandor_influence = 100 }
	set_variable = { lthi_base_noldor_influence = 35 }
	set_variable = { lthi_base_sindar_influence = 30 }
	set_variable = { lthi_base_halfelves_influence = 5 }
	set_variable = { lthi_base_nonelves_influence = 0 }
	set_variable = { lthi_base_orcs_influence = 0 }

	force_update_dynamic_modifier = yes

	add_dynamic_modifier = {
		modifier = lothlorien_base_influences
	}
	add_dynamic_modifier = {
		modifier = lthi_influence_bonuses
	}

	# Bonus variables
	set_variable = { lthi_nandor_bonus_conscription = 0 }
	set_variable = { lthi_nandor_bonus_speed = 0 }
	set_variable = { lthi_nandor_bonus_organization = 0 }

	set_variable = { lthi_noldor_bonus_attack = 0 }
	set_variable = { lthi_noldor_bonus_breakthrough = 0 }
	set_variable = { lthi_noldor_bonus_factoryoutput = 0 }

	set_variable = { lthi_sindar_bonus_constructionspeed = 0 }
	set_variable = { lthi_sindar_bonus_supply = 0 }
	set_variable = { lthi_sindar_bonus_research = 0 }

	set_variable = { lthi_halfelves_bonus_experiencegain = 0 }
	set_variable = { lthi_halfelves_bonus_stability = 0 }
	set_variable = { lthi_halfelves_bonus_consumergoods = 0 }

	set_variable = { lthi_nonelves_bonus_monthlypop = 0 }
	set_variable = { lthi_orcs_bonus_strength = 0 }

	# max bonus vars
	set_variable = { lthi_nandor_bonus_conscription_base = 0.1 }
	set_variable = { lthi_nandor_bonus_speed_base = 0 }
	set_variable = { lthi_nandor_bonus_organization_base = 0 }

	set_variable = { lthi_noldor_bonus_attack_base = 0.1 }
	set_variable = { lthi_noldor_bonus_breakthrough_base = 0 }
	set_variable = { lthi_noldor_bonus_factoryoutput_base = 0 }

	set_variable = { lthi_sindar_bonus_constructionspeed_base = 0.1 }
	set_variable = { lthi_sindar_bonus_supply_base = 0 }
	set_variable = { lthi_sindar_bonus_research_base = 0 }

	set_variable = { lthi_halfelves_bonus_experiencegain_base = 0.1 }
	set_variable = { lthi_halfelves_bonus_stability_base = 0 }
	set_variable = { lthi_halfelves_bonus_consumergoods_base = 0 }

	set_variable = { lthi_nonelves_bonus_monthlypop_base = 0.1 }
	set_variable = { lthi_orcs_bonus_strength_base = 0.1 }

	lthi_update_values = yes
}


# Call this every time one of the influence vars is changed
lthi_update_values = {
	# Calculate sum
	set_variable = { lthi_influence_sum = modifier@nandor_influence }
	add_to_variable = { lthi_influence_sum = modifier@noldor_influence }
	add_to_variable = { lthi_influence_sum = modifier@sindar_influence }
	add_to_variable = { lthi_influence_sum = modifier@halfelves_influence }
	add_to_variable = { lthi_influence_sum = modifier@nonelves_influence }
	add_to_variable = { lthi_influence_sum = modifier@orcs_influence }

	# Calculate fractions
	set_variable = { lthi_nandor_influence_fraction = modifier@nandor_influence }
	set_variable = { lthi_noldor_influence_fraction = modifier@noldor_influence }
	set_variable = { lthi_sindar_influence_fraction = modifier@sindar_influence }
	set_variable = { lthi_halfelves_influence_fraction = modifier@halfelves_influence }
	set_variable = { lthi_nonelves_influence_fraction = modifier@nonelves_influence }
	set_variable = { lthi_orcs_influence_fraction = modifier@orcs_influence }
	divide_variable = { lthi_nandor_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_noldor_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_sindar_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_halfelves_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_nonelves_influence_fraction = lthi_influence_sum }
	divide_variable = { lthi_orcs_influence_fraction = lthi_influence_sum }

	# Set bonus nandor
	set_variable = { lthi_nandor_bonus_conscription = lthi_nandor_bonus_conscription_base }
	set_variable = { lthi_nandor_bonus_speed = lthi_nandor_bonus_speed_base }
	set_variable = { lthi_nandor_bonus_organization = lthi_nandor_bonus_organization_base }
	multiply_variable = { lthi_nandor_bonus_conscription = lthi_nandor_influence_fraction }
	multiply_variable = { lthi_nandor_bonus_speed = lthi_nandor_influence_fraction }
	multiply_variable = { lthi_nandor_bonus_organization = lthi_nandor_influence_fraction }
		
	# Set bonus noldor
	set_variable = { lthi_noldor_bonus_attack = lthi_noldor_bonus_attack_base }
	set_variable = { lthi_noldor_bonus_breakthrough = lthi_noldor_bonus_breakthrough_base }
	set_variable = { lthi_noldor_bonus_factoryoutput = lthi_noldor_bonus_factoryoutput_base }
	multiply_variable = { lthi_noldor_bonus_attack = lthi_noldor_influence_fraction }
	multiply_variable = { lthi_noldor_bonus_breakthrough = lthi_noldor_influence_fraction }
	multiply_variable = { lthi_noldor_bonus_factoryoutput = lthi_noldor_influence_fraction }

	# Set bonus sindar
	set_variable = { lthi_sindar_bonus_constructionspeed = lthi_sindar_bonus_constructionspeed_base }
	set_variable = { lthi_sindar_bonus_supply = lthi_sindar_bonus_supply_base }
	set_variable = { lthi_sindar_bonus_research = lthi_sindar_bonus_research_base }
	multiply_variable = { lthi_sindar_bonus_constructionspeed = lthi_sindar_influence_fraction }
	multiply_variable = { lthi_sindar_bonus_supply = lthi_sindar_influence_fraction }
	multiply_variable = { lthi_sindar_bonus_research = lthi_sindar_influence_fraction }

	# Set bonus halfelves
	set_variable = { lthi_halfelves_bonus_experiencegain = lthi_halfelves_bonus_experiencegain_base }
	set_variable = { lthi_halfelves_bonus_stability = lthi_halfelves_bonus_stability_base }
	set_variable = { lthi_halfelves_bonus_consumergoods = lthi_halfelves_bonus_consumergoods_base }
	multiply_variable = { lthi_halfelves_bonus_experiencegain = lthi_halfelves_influence_fraction }
	multiply_variable = { lthi_halfelves_bonus_stability = lthi_halfelves_influence_fraction }
	multiply_variable = { lthi_halfelves_bonus_consumergoods = lthi_halfelves_influence_fraction }

	# Set bonus nonelves
	set_variable = { lthi_nonelves_bonus_monthlypop = lthi_nonelves_bonus_monthlypop_base }
	multiply_variable = { lthi_nonelves_bonus_monthlypop = lthi_nonelves_influence_fraction }

	# Set bonus orcs
	set_variable = { lthi_orcs_bonus_strength = lthi_orcs_bonus_strength_base }
	multiply_variable = { lthi_orcs_bonus_strength = lthi_orcs_influence_fraction }

	# If we have the unity_in_division modifer we need to find out how "evened out" the influence is
	# For this, we fing the highest and lowest values
	if = {
		limit = { has_dynamic_modifier = { modifier = lth_unity_in_division_modifier } }

		add_to_temp_array = { temp_infl = modifier@nandor_influence }
		add_to_temp_array = { temp_infl = modifier@noldor_influence }
		add_to_temp_array = { temp_infl = modifier@sindar_influence }
		add_to_temp_array = { temp_infl = modifier@halfelves_influence }
		if = {
			limit = { check_variable = { modifier@nonelves_influence > 0 } }
			add_to_temp_array = { temp_infl = modifier@nonelves_influence }
		}
		if = {
			limit = { check_variable = { modifier@orcs_influence > 0 } }
			add_to_temp_array = { temp_infl = modifier@orcs_influence }
		}

		find_highest_in_array = {
    		array = temp_infl
			value = temp_highest_influence
		}

		find_lowest_in_array = {
    		array = temp_infl
			value = temp_lowest_influence
		}

		# We subtract from 1 the difference between highest and lowest
		subtract_from_temp_variable = { temp_highest_influence = temp_lowest_influence }
		set_variable = { lth_influence_spread_bonus = 1 }
		subtract_from_variable = { lth_influence_spread_bonus = temp_highest_influence }

		# Multiply with base value (maximum bonus)
		multiply_variable = { lth_influence_spread_bonus = 0.15 }
	}
}


lthi_increase_influence_nandor_minor = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 10
		tooltip = increase_influence_nandor_minor_tt
	}
}

lthi_increase_influence_nandor_intermediate = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 25
		tooltip = increase_influence_nandor_intermediate_tt
	}
}

lthi_increase_influence_nandor_major = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = 50
		tooltip = increase_influence_nandor_major_tt
	}
}

lthi_increase_influence_noldor_minor = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 10
		tooltip = increase_influence_noldor_minor_tt
	}
}

lthi_increase_influence_noldor_intermediate = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 25
		tooltip = increase_influence_noldor_intermediate_tt
	}
}

lthi_increase_influence_noldor_major = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = 50
		tooltip = increase_influence_noldor_major_tt
	}
}

lthi_increase_influence_sindar_minor = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 10
		tooltip = increase_influence_sindar_minor_tt
	}
}

lthi_increase_influence_sindar_intermediate = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 25
		tooltip = increase_influence_sindar_intermediate_tt
	}
}

lthi_increase_influence_sindar_major = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = 50
		tooltip = increase_influence_sindar_major_tt
	}
}

lthi_increase_influence_nonelves_minor = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 10
		tooltip = increase_influence_nonelves_minor_tt
	}
}

lthi_increase_influence_nonelves_intermediate = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 25
		tooltip = increase_influence_nonelves_intermediate_tt
	}
}

lthi_increase_influence_nonelves_major = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = 50
		tooltip = increase_influence_nonelves_major_tt
	}
}

lthi_increase_influence_orcs_minor = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 10
		tooltip = increase_influence_orcs_minor_tt
	}
}

lthi_increase_influence_orcs_intermediate = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 25
		tooltip = increase_influence_orcs_intermediate_tt
	}
}

lthi_increase_influence_orcs_major = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = 50
		tooltip = increase_influence_orcs_major_tt
	}
}

lthi_increase_influence_halfelves_minor = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 10
		tooltip = increase_influence_halfelves_minor_tt
	}
}

lthi_increase_influence_halfelves_intermediate = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 25
		tooltip = increase_influence_halfelves_intermediate_tt
	}
}

lthi_increase_influence_halfelves_major = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = 50
		tooltip = increase_influence_halfelves_major_tt
	}
}

lthi_decrease_influence_nandor_minor = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -10
		tooltip = decrease_influence_nandor_minor_tt
	}
}

lthi_decrease_influence_nandor_intermediate = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -25
		tooltip = decrease_influence_nandor_intermediate_tt
	}
}

lthi_decrease_influence_nandor_major = {
	add_to_variable = {
		var = lthi_base_nandor_influence
		value = -50
		tooltip = decrease_influence_nandor_major_tt
	}
}

lthi_decrease_influence_noldor_minor = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -10
		tooltip = decrease_influence_noldor_minor_tt
	}
}

lthi_decrease_influence_noldor_intermediate = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -25
		tooltip = decrease_influence_noldor_intermediate_tt
	}
}

lthi_decrease_influence_noldor_major = {
	add_to_variable = {
		var = lthi_base_noldor_influence
		value = -50
		tooltip = decrease_influence_noldor_major_tt
	}
}

lthi_decrease_influence_sindar_minor = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -10
		tooltip = decrease_influence_sindar_minor_tt
	}
}

lthi_decrease_influence_sindar_intermediate = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -25
		tooltip = decrease_influence_sindar_intermediate_tt
	}increase
}

lthi_decrease_influence_sindar_major = {
	add_to_variable = {
		var = lthi_base_sindar_influence
		value = -50
		tooltip = decrease_influence_sindar_major_tt
	}
}

lthi_decrease_influence_halfelves_minor = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -10
		tooltip = decrease_influence_halfelves_minor_tt
	}
}

lthi_decrease_influence_halfelves_intermediate = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -25
		tooltip = decrease_influence_halfelves_intermediate_tt
	}
}

lthi_decrease_influence_halfelves_major = {
	add_to_variable = {
		var = lthi_base_halfelves_influence
		value = -50
		tooltip = decrease_influence_halfelves_major_tt
	}
}

lthi_decrease_influence_nonelves_minor = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -10
		tooltip = decrease_influence_nonelves_minor_tt
	}
}

lthi_decrease_influence_nonelves_intermediate = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -25
		tooltip = decrease_influence_nonelves_intermediate_tt
	}
}

lthi_decrease_influence_nonelves_major = {
	add_to_variable = {
		var = lthi_base_nonelves_influence
		value = -50
		tooltip = decrease_influence_nonelves_major_tt
	}
}

lthi_decrease_influence_orcs_minor = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -10
		tooltip = decrease_influence_orcs_minor_tt
	}
}

lthi_decrease_influence_orcs_intermediate = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -25
		tooltip = decrease_influence_orcs_intermediate_tt
	}
}

lthi_decrease_influence_orcs_major = {
	add_to_variable = {
		var = lthi_base_orcs_influence
		value = -50
		tooltip = decrease_influence_orcs_major_tt
	}
}



lthi_decrease_cw_timer = {
	# TODO
}

lthi_increase_cw_timer = {
	# TODO
}

lthi_increase_bonus_nandor = {
	# TODO
}

lthi_increase_bonus_noldor = {
	# TODO
}

lthi_increase_bonus_sindar = {
	# TODO
}

lthi_increase_bonus_halfelves = {
	# TODO
}

lthi_decrease_bonus_nandor = {
	# TODO
}

lthi_decrease_bonus_noldor = {
	# TODO
}

lthi_decrease_bonus_sindar = {
	# TODO
}

lthi_decrease_bonus_halfelves = {
	# TODO
}

lthi_decrease_bonus_nandor_major = {
	# TODO
}

lthi_decrease_bonus_noldor_major = {
	# TODO
}

lthi_decrease_bonus_sindar_major = {
	# TODO
}

lthi_decrease_bonus_halfelves_major = {
	# TODO
}


lthi_send_to_valinor_nandor = {
	# TODO
}

lthi_send_to_valinor_noldor = {
	# TODO
}

lthi_send_to_valinor_sindar = {
	# TODO
}

lthi_send_to_valinor_halfelves = {
	# TODO
}


lth_on_weekly = {
	lthi_update_values = yes
}


lth_on_yearly = {
	# immortal endurance growth
	if = {
		limit = {
			has_completed_focus = lth_endurethedarkness
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			check_variable = { lth_immortal_endurance_bonus < 0.5 } # cap
		}
		add_to_variable = { lth_immortal_endurance_bonus = 0.05 }
	}
	else_if = {
		limit = {
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			check_variable = { lth_immortal_endurance_bonus < 0.15 } # cap
		}

		add_to_variable = { lth_immortal_endurance_bonus = 0.03 }
	}

	if = {
		limit = {
			has_dynamic_modifier = { modifier = lth_immortal_endurance_modifier }
			has_completed_focus = lth_preservationofknowledge
		}
		set_variable = { lth_preservationofknowledge_bonus = var:lth_immortal_endurance_bonus }
	}
}

# Make the isoloationist_resevations idea less bad
lth_lower_isolationist_reservations = {
	if = {
		limit = { has_idea = LTH_isolationist_reservations_3 }
		swap_ideas = {
			remove_idea = LTH_isolationist_reservations_3
			add_idea = LTH_isolationist_reservations_2
		}
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_2 }
		swap_ideas = {
			remove_idea = LTH_isolationist_reservations_2
			add_idea = LTH_isolationist_reservations_1
		}
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_1 }
		remove_ideas = LTH_isolationist_reservations_1
	}
	else_if = {
		limit = { has_idea = LTH_isolationist_reservations_total_isolation }
		add_political_power = 100
	}
}

lthi_activate_nonelves = {
	add_to_variable = { lthi_base_nonelves_influence = 50 }
}

lthi_activate_orcs = {
	add_to_variable = { lthi_base_orcs_influence = 50 }
}