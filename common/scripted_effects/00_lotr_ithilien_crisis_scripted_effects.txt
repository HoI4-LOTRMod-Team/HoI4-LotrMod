

# Happens when mordor does the Ithilien crisis focus. Scope is MOR
ithc_commence_ithilien_crisis = {

	hidden_effect = {
		GON = { ithc_set_vars_long_term = yes }
		MOR = { ithc_set_vars_long_term = yes }

		set_global_flag = ithc_ithilien_crisis_commenced

		GON = { country_event = ithc.1 }
		MOR = { country_event = ithc.2 }
	}

	custom_effect_tooltip = ithc_commence_ithilien_crisis_tt
}

ithc_set_vars_long_term = {
	hidden_effect = {
		set_variable = { ithc_subterfuge_decision_cost_pp = 30 }
		set_variable = { ithc_pillage_decision_cost_pp = 30 }
		set_variable = { ithc_pillage_decision_cost_pp_scaling = 30 }

		set_variable = { ithc_subterfuge_decision_cost_days = 30 }
		set_variable = { ithc_pillage_decision_cost_days = 30 }
		set_variable = { ithc_pillage_decision_cost_days_scaling = 30 }
	}
	custom_effect_tooltip = ithc_set_vars_long_term_tt
}

ithc_set_vars_short_term = {
	hidden_effect = {
		set_variable = { ithc_subterfuge_decision_cost_pp = 30 }
		set_variable = { ithc_pillage_decision_cost_pp = 30 }
		set_variable = { ithc_pillage_decision_cost_pp_scaling = 30 }

		set_variable = { ithc_subterfuge_decision_cost_days = 30 }
		set_variable = { ithc_pillage_decision_cost_days = 30 }
		set_variable = { ithc_pillage_decision_cost_days_scaling = 30 }	
	}
	custom_effect_tooltip = ithc_set_vars_short_term_tt
}

# Happens when GON and MOR got to war. Runs on no scope in particular
ithc_end_ithilien_crisis = {
	clr_global_flag = ithc_ithilien_crisis_commenced

	# Add the cores back that were removed
	22 = { add_core_of = GON }
	175 = { add_core_of = GON }
	173 = { add_core_of = GON }
	135 = { add_core_of = GON }
}


# THIS is the state to run effects on.
ithc_on_war_with_mordor_effects = {

	set_global_flag = mordor_gondor_war

	ithc_end_ithilien_crisis = yes

	if = {
		limit = { has_dynamic_modifier = { modifier = ithc_sabotaged_infrastructure_prewar_modifier } }
		remove_dynamic_modifier = { modifier = ithc_sabotaged_infrastructure_prewar_modifier }
		ithc_subterfuge_sabotage_infrastructure_on_war = yes
	}
	if = {
		limit = { has_dynamic_modifier = { modifier = ithc_defenses_located_prewar_modifier } }
		remove_dynamic_modifier = { modifier = ithc_defenses_located_prewar_modifier }
		ithc_subterfuge_locate_defenses_on_war = yes
	}
	if = {
		limit = { has_dynamic_modifier = { modifier = ithc_weapon_caches_prewar_modifier } }
		remove_dynamic_modifier = { modifier = ithc_weapon_caches_prewar_modifier }
		ithc_subterfuge_hide_weapon_caches_on_war = yes
	}
	if = {
		limit = { has_dynamic_modifier = { modifier = ithc_sleeper_cells_planted_prewar_modifier } }
		remove_dynamic_modifier = { modifier = ithc_sleeper_cells_planted_prewar_modifier }
		ithc_subterfuge_plant_sleeper_cells_on_war = yes
	}
}


# MOR contests a state -> Gon looses core and she shitshow begins
ithc_contest_state = {

	hidden_effect = {
		#remove_core_of = GON
		#set_compliance = 80
		#set_resistance = 0

		force_enable_resistance = GON
		start_resistance = yes

		set_state_flag = ithc_contested

		set_variable = { ithc_subterfuge_level = 0 }
		set_variable = { ithc_pillage_level = 0 }

		ithc_subterfuge_enable_new_decision = yes
		ithc_pillage_enable_new_decision = yes
	}
	effect_tooltip = {
		#remove_core_of = GON

		start_resistance = yes

		ithc_subterfuge_enable_new_decision = yes
		ithc_pillage_enable_new_decision = yes
	}
}


# Will make a new subterfuge deicion available for MOR in this state
ithc_subterfuge_enable_new_decision = {
	
	custom_effect_tooltip = ithc_subterfuge_enable_new_decision_tt

	hidden_effect = {
		random_list = {
			1 = {
				set_state_flag = ithc_subterfuge_gather_intelligence_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_dynamic_modifier = { modifier = ithc_sabotaged_infrastructure_prewar_modifier }
				}
				set_state_flag = ithc_subterfuge_sabotage_infrastructure_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_dynamic_modifier = { modifier = ithc_defenses_located_prewar_modifier }
				}
				set_state_flag = ithc_subterfuge_locate_defenses_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_dynamic_modifier = { modifier = ithc_weapon_caches_prewar_modifier }
				}
				set_state_flag = ithc_subterfuge_hide_weapon_caches_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_dynamic_modifier = { modifier = ithc_sleeper_cells_planted_prewar_modifier }
				}
				set_state_flag = ithc_subterfuge_plant_sleeper_cells_enabled
			}
		}
	}
}


# Will make a new pillage deicion available for MOR in this state
ithc_pillage_enable_new_decision = {
	
	custom_effect_tooltip = ithc_pillage_enable_new_decision_tt

	hidden_effect = {
		random_list = {
			1 = {
				set_state_flag = ithc_pillage_ambush_the_garrison_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_population_massacred
				}
				set_state_flag = ithc_pillage_massacre_the_population_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_layed_waste
				}
				set_state_flag = ithc_pillage_lay_waste_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_plundered
				}
				set_state_flag = ithc_pillage_plunder_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_fields_burned
				}
				set_state_flag = ithc_pillage_burn_and_sear_the_fields_enabled
			}
		}	
	}
}


ithc_begin_subterfuge_decision = {
	set_state_flag = ithc_subterfuge_operation
}

ithc_begin_pillage_decision = {
	set_state_flag = ithc_pillage_operation
}

ithc_end_subterfuge_decision = {
	clr_state_flag = ithc_subterfuge_operation
	add_to_variable  = { ithc_subterfuge_level = 1 }

	custom_effect_tooltip = ithc_increase_subterfuge_tt
}

ithc_end_pillage_decision = {
	clr_state_flag = ithc_pillage_operation
	add_to_variable  = { ithc_pillage_level = 1 }

	custom_effect_tooltip = ithc_increase_pillage_tt
}



ithc_subterfuge_sabotage_infrastructure_on_war = {
	
	damage_building = { type = infrastructure damage = 2}
	add_dynamic_modifier = {
		modifier = ithc_sabotaged_infrastructure_modifier
		days = 140
	}
}

ithc_subterfuge_locate_defenses_on_war = {
	
	add_dynamic_modifier = {
		modifier = ithc_defenses_located_modifier
		days = 140
	}
}

ithc_subterfuge_hide_weapon_caches_on_war = {
	
	add_dynamic_modifier = {
		modifier = ithc_weapon_caches_modifier
		days = 140
	}
}

ithc_subterfuge_plant_sleeper_cells_on_war = {

	if = {
		limit = { state = 22 }
		load_oob = ithc_slepper_cells_22
	}
	else_if = {
		limit = { state = 175 }
		load_oob = ithc_slepper_cells_175
	}
	else_if = {
		limit = { state = 173 }
		load_oob = ithc_slepper_cells_173
	}
	else_if = {
		limit = { state = 135 }
		load_oob = ithc_slepper_cells_135
	}
}



