

# Happens when mordor does the Ithilien crisis focus. Scope is MOR
ithc_commence_ithilien_crisis = {
	set_global_flag = ithc_ithilien_crisis_commenced
}

# Happens when GON and MOR got to war. Runs on no scope in particular
ithc_end_ithilien_crisis = {
	clr_global_flag = ithc_ithilien_crisis_commenced

	# Add the cores back that were removed
	22 = { add_core_of = GON }
	175 = { add_core_of = GON }
	173 = { add_core_of = GON }
	135 = { add_core_of = GON }
}


# THIS is the state to run effects on.
ithc_on_war_with_mordor_effects = {

	ithc_end_ithilien_crisis = yes

	if = {
		limit = { has_state_flag = ithc_infrastructure_sabotaged }
		ithc_subterfuge_sabotage_infrastructure_on_war = yes
	}
	if = {
		limit = { has_state_flag = ithc_defenses_located }
		ithc_subterfuge_locate_defenses_on_war = yes
	}
	if = {
		limit = { has_state_flag = ithc_hidden_weapon_caches }
		ithc_subterfuge_hide_weapon_caches_on_war = yes
	}
	if = {
		limit = { has_state_flag = ithc_sleeper_cells_planted }
		ithc_subterfuge_plant_sleeper_cells_on_war = yes
	}
}


# MOR contests a state -> Gon looses core and she shitshow begins
ithc_contest_state = {

	hidden_effect = {
		remove_core_of = GON
		set_compliance = 80
		set_resistance = 0

		set_state_flag = ithc_contested

		set_variable = { ithc_subterfuge_level = 0 }
		set_variable = { ithc_pillage_level = 0 }

		ithc_subterfuge_enable_new_decision = yes
		ithc_pillage_enable_new_decision = yes
	}
	effect_tooltip = {
		remove_core_of = GON
		ithc_subterfuge_enable_new_decision = yes
		ithc_pillage_enable_new_decision = yes
	}
}


# Will make a new subterfuge deicion available for MOR in this state
ithc_subterfuge_enable_new_decision = {
	
	custom_effect_tooltip = ithc_subterfuge_enable_new_decision_tt

	hidden_effect = {
		random_list = {
			1 = {
				set_state_flag = ithc_subterfuge_gather_intelligence_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_infrastructure_sabotaged
				}
				set_state_flag = ithc_subterfuge_sabotage_infrastructure_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_defenses_located
				}
				set_state_flag = ithc_subterfuge_locate_defenses_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_hidden_weapon_caches
				}
				set_state_flag = ithc_subterfuge_hide_weapon_caches_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_sleeper_cells_planted
				}
				set_state_flag = ithc_subterfuge_plant_sleeper_cells_enabled
			}
		}
	}
}


# Will make a new pillage deicion available for MOR in this state
ithc_pillage_enable_new_decision = {
	
	custom_effect_tooltip = ithc_pillage_enable_new_decision_tt

	hidden_effect = {
		random_list = {
			1 = {
				set_state_flag = ithc_pillage_ambush_the_garrison_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_population_massacred
				}
				set_state_flag = ithc_pillage_massacre_the_population_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_layed_waste
				}
				set_state_flag = ithc_pillage_lay_waste_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_plundered
				}
				set_state_flag = ithc_pillage_plunder_enabled
			}
			1 = {
				modifier = {
					factor = 0
					has_state_flag = ithc_fields_burned
				}
				set_state_flag = ithc_pillage_burn_and_sear_the_fields_enabled
			}
		}	
	}
}


ithc_begin_subterfuge_decision = {
	set_state_flag = ithc_subterfuge_operation
}

ithc_begin_pillage_decision = {
	set_state_flag = ithc_pillage_operation
}

ithc_end_subterfuge_decision = {
	clr_state_flag = ithc_subterfuge_operation
	add_to_variable  = { ithc_subterfuge_level = 1 }
}

ithc_end_pillage_decision = {
	clr_state_flag = ithc_pillage_operation
	add_to_variable  = { ithc_pillage_level = 1 }
}



ithc_subterfuge_sabotage_infrastructure_on_war = {
	
	damage_building = { type = infrastructure damage = 2}
	# add ithc_sabotaged_infrastructure_modifier
}

ithc_subterfuge_locate_defenses_on_war = {
	
	# add ithc_defenses_located_modifier
}

ithc_subterfuge_hide_weapon_caches_on_war = {
	
	# add ithc_weapon_caches_modifier
}

ithc_subterfuge_plant_sleeper_cells_on_war = {

	if = {
		limit = { state = 22 }
		load_oob = ithc_slepper_cells_22
	}
	else_if = {
		limit = { state = 175 }
		load_oob = ithc_slepper_cells_175
	}
	else_if = {
		limit = { state = 173 }
		load_oob = ithc_slepper_cells_173
	}
	else_if = {
		limit = { state = 135 }
		load_oob = ithc_slepper_cells_135
	}
}



